<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIを使ったアプリケーション</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- <script src="https://cdn.tailwindcss.com"></script>　tailwindcss読み込み -->
</head>
<body>
  <div>
    <div id="favarites" style="overflow: auto;height: 600px;"></div>
  </div>

  
  <h1 class='mb16'></h1>

  <input class='input bg-white mb16' type='search' id='search' />
  <button id="searchButton">検索</button>
  <div>
    <h2 class='mb8'>検索結果</h2>
    <div id='results'></div>
  </div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<script src="js/main.js"></script>
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } 
        from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved, onChildChanged, get}
        from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {

    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app); //RealtimeDBに接続
    const dbRef = ref(db, "chat"); //RealtimeDB内の"chat"を使う


    document.addEventListener('click', function(e) {
        if (e.target.matches('.favButton')) {
            let book = {
                title: e.target.dataset.title,
                description: e.target.dataset.description,
                link: e.target.dataset.link,
                image: e.target.dataset.image,
                readCount: 0,
            };
        
            const favRef = ref(db, "favorites"); //RealtimeDB内の"favorites"を使う
            const newPostRef = push(favRef); //ユニークKEYを生成
            set(newPostRef, book); //"favorites"にユニークKEYをつけてオブジェクトデータを登録
        }
    });


    document.addEventListener('click', function(e) {
        if (e.target.matches('.removeFavButton')) {
            const key = e.target.dataset.key;
            
            const bookRef = ref(db, `favorites/${key}`);
            remove(bookRef);
        }
    });

    document.addEventListener('click', function(e) {
        if(e.target.matches('.readButton')){
            const key = e.target.dataset.key;
            const bookRef = ref(db, `favorites/${key}`);

            get(bookRef)
            .then((snapshot) => {
                if(snapshot.exists()) {
                    let book = snapshot.val();
                    book.readCount += 1;
                    set(bookRef, book);
                }
            });
        }
    });

    const favRef = ref(db, "favorites");
    onChildAdded(favRef, function (data) {
        const book = data.val(); 
        const key = data.key;

        let h =`
            <div id = '${key}'>
                <h3>${book.title}</h3>
                <p>${book.description}</p>
                <img src="${book.image}" />
                <button class="removeFavButton" data-key="${key}">Remove from favorites</button>
                <p class="readCount">Read count: ${book.readCount}</p>
                <button class="readButton" data-key="${key}">読んだよ</button>
            </div>
        `
        $("#favarites").append(h); //#favaritesの最後に追加 
    });

    onChildRemoved(favRef, function(data){
        const key = data.key;
        //DOM から該当する要素を削除
        const element = document.getElementById(key);
        if(element) {
            element.remove();
        }
    });

    onChildChanged(favRef, function(data) {
        const book = data.val();
        const key = data.key;
        const element = document.getElementById(key);
        if (element) {
            element.querySelector('.readCount').textContent = `Read count: ${book.readCount}`;
        }
    });
</script> 
</body>
</html>